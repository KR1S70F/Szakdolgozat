<!DOCTYPE html>
<html>
<head>
    <title>ESP32 Szűkített FFT Spektrum (0-2500 Hz)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
        }
        #fftChart {
            /* A diagram maximális szélessége */
            max-width: 1550px; 
            max-height: 500px;
        }
        #download-block {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>

    <h1>ESP32 FFT Spektrum (0-2500 Hz, kb. 86 Hz-es lépésekben)</h1>
    
    <div id="download-block">
        <h3>Adatletöltés (CSV)</h3>
        <p>A mentett adatok letöltéséhez kattintson a linkre (az ESP32 Web Server-e szolgálja ki).</p>
        
        <a id="downloadLink" href="#" target="_blank">
            ⬇️ Letöltés: fft_data.csv
        </a>
    </div>
    <canvas id="fftChart" width="800" height="400"></canvas>
    <p>Állapot: <span id="status">Kapcsolódás...</span></p>

    <script>

        // SAJÁT ESP32 IP-CÍM KELL!

        const ESP32_IP = "172.20.10.6"; // A Serial Monitorban kiírt IP-cím
        const WEBSOCKET_PORT = 81; 
        
        const websocket = new WebSocket(`ws://${ESP32_IP}:${WEBSOCKET_PORT}/`);

        let fftChart;
        const SAMPLES = 1024;
        const SAMPLING_FREQUENCY = 44100;
        const FREQUENCY_RESOLUTION = SAMPLING_FREQUENCY / SAMPLES; 

        // SZŰKÍTETT TARTOMÁNY KONSTANS
        const MAX_FREQ_DISPLAY = 2500; // Maximális megjelenített frekvencia
        
        // Kiszámoljuk, hány FFT bint kell felhasználni az 2500 Hz-hez
        const MAX_BINS_DISPLAY = Math.ceil(MAX_FREQ_DISPLAY / FREQUENCY_RESOLUTION);

        // X-tengely címkék létrehozása (csak 2500 Hz-ig)
        const labels = [];
        for (let i = 0; i < MAX_BINS_DISPLAY; i++) {
            labels.push((i * FREQUENCY_RESOLUTION).toFixed(0)); 
        }


        // ----------------------------------------------------
        // DIAGRAM INICIALIZÁLÁSA (Chart.js)
        // ----------------------------------------------------

        window.onload = function() {
            const ctx = document.getElementById('fftChart').getContext('2d');

            // --- DINAMIKUS LETÖLTÉSI LINK BEÁLLÍTÁSA ---
            document.getElementById('downloadLink').href = `http://${ESP32_IP}/download`;
            
            fftChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'FFT Amplitúdó (Magnitude)',
                        data: [], 
                        borderColor: 'rgb(75, 192, 192)',
                        borderWidth: 1,
                        pointRadius: 0, 
                    }]
                },
                options: {
                    animation: false, 
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: `Frekvencia (Hz) - Maximum ${MAX_FREQ_DISPLAY} Hz`
                            },
                            ticks: {
                                stepSize: 2, 
                                autoSkip: false, 
                                maxRotation: 0 
                            }
                        },
                        y: {
                            beginAtZero: true,
                            // Függőleges skála maximuma
                            max: 2500000000, 
                            title: {
                                display: true,
                                text: 'Amplitúdó (Magnitude)'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        };


        // ----------------------------------------------------
        // WEBSOCKET ÉS ADATKEZELÉS
        // ----------------------------------------------------

        websocket.onopen = function() {
            document.getElementById('status').textContent = "CSATLAKOZTATVA";
        };

        websocket.onerror = function(error) {
            document.getElementById('status').textContent = "HIBA! Ellenőrizze az IP-címet és az ESP32-t.";
            console.log("WebSocket hiba: ", error);
        };

        websocket.onclose = function() {
            document.getElementById('status').textContent = "KAPCSOLAT MEGSZAKADT";
        };

        // Adatok fogadása és diagram frissítése
        websocket.onmessage = function(event) {
            const rawData = event.data;
            const fullData = rawData.split(',').map(Number); 

            // Szűkítés: Csak a MAX_BINS_DISPLAY mennyiségű adatot használjuk
            const limitedData = fullData.slice(0, MAX_BINS_DISPLAY);

            if (fftChart) {
                fftChart.data.datasets[0].data = limitedData;
                fftChart.update();
            }
        };

    </script>
</body>
</html>